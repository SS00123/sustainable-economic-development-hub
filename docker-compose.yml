# Docker Compose for Analytics Hub Platform
# Sustainable Economic Development Analytics Hub
# Ministry of Economy and Planning

version: '3.8'

x-common-env: &common-env
  ANALYTICS_HUB_ENV: production
  ANALYTICS_HUB_DEBUG: "false"
  LOG_LEVEL: INFO
  TZ: Asia/Riyadh

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 30s

services:
  # Streamlit Dashboard
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: analytics-hub-dashboard:${VERSION:-latest}
    container_name: analytics-hub-dashboard
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    environment:
      <<: *common-env
      SERVICE_NAME: dashboard
    volumes:
      - app-data:/app/data
      - app-logs:/app/logs
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD-SHELL", "curl --fail --silent --max-time 5 http://localhost:8501/_stcore/health || exit 1"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

  # FastAPI Backend
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: analytics-hub-api:${VERSION:-latest}
    container_name: analytics-hub-api
    command: >
      uvicorn main_api:app 
      --host 0.0.0.0 
      --port 8000
      --workers ${API_WORKERS:-2}
      --access-log
      --log-level info
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      <<: *common-env
      SERVICE_NAME: api
    volumes:
      - app-data:/app/data
      - app-logs:/app/logs
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD-SHELL", "curl --fail --silent --max-time 5 http://localhost:8000/api/v1/health || exit 1"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp
    depends_on:
      dashboard:
        condition: service_healthy

  # Nginx Reverse Proxy (optional production setup)
  nginx:
    image: nginx:1.25-alpine
    container_name: analytics-hub-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - dashboard
      - api
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
    profiles:
      - production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run

volumes:
  app-data:
    driver: local
  app-logs:
    driver: local

networks:
  default:
    name: analytics-hub-network
    driver: bridge
